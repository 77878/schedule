<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>智能排班 V2.3 - 橫列清單版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0b1120; color: #f1f5f9; font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .card { background-color: #1e293b; border-radius: 12px; padding: 0.75rem; border: 1px solid #334155; }
        .day-row { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid #334155; }
        .slot { width: 14px; height: 14px; border-radius: 3px; border: 1px solid #475569; cursor: pointer; }
        .slot.active { background-color: #38bdf8; border-color: #38bdf8; box-shadow: 0 0 8px rgba(56, 189, 248, 0.4); }
        .shift-tag { font-size: 10px; font-weight: 800; padding: 2px 6px; border-radius: 4px; background: #0f172a; color: #94a3b8; min-width: 45px; text-align: center; }
        .shift-tag.filled { color: #38bdf8; border: 1px solid #38bdf8/30; }
        .btn-magic { background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%); }
    </style>
</head>
<body class="p-4 pb-20">
    <div class="max-w-md mx-auto space-y-4">
        
        <div class="flex justify-between items-end mb-4">
            <div>
                <h1 class="text-xl font-black text-white italic tracking-tighter">LIST SCHEDULER V2.3</h1>
                <p class="text-[9px] text-slate-500 font-bold uppercase">點選小格畫班：早 / 午 / 晚</p>
            </div>
            <button onclick="autoFillAll()" class="btn-magic text-white text-[10px] font-black px-4 py-2 rounded-lg shadow-lg">
                ✨ 一鍵填補全月空缺
            </button>
        </div>

        <div class="flex gap-4 justify-center py-2 border-y border-slate-800 mb-2">
            ${staffList.map(n => `<span class="text-[10px] font-bold text-slate-400">${n}</span>`).join('')}
        </div>

        <div id="list_container" class="space-y-1">
            </div>

    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-slate-900/90 backdrop-blur-md p-3 border-t border-slate-700">
        <div id="t_stats" class="max-w-md mx-auto flex justify-around text-[10px] font-black text-indigo-400"></div>
    </div>

    <script>
        const staffList = ["A", "B", "C", "D", "E"];
        let db = JSON.parse(localStorage.getItem('monthly_schedule_v2.3')) || {};

        function getDow(d) {
            return ["日", "一", "二", "三", "四", "五", "六"][d % 7];
        }

        function render() {
            const container = document.getElementById('list_container');
            container.innerHTML = '';

            for (let d = 1; d <= 28; d++) {
                const dow = getDow(d);
                const dayData = db[d] || { userPicks: {}, finalShifts: {} };
                
                const row = document.createElement('div');
                row.className = "card mb-2";
                
                let staffHtml = staffList.map(name => {
                    const picks = dayData.userPicks[name] || [false, false, false];
                    return `
                        <div class="flex flex-col items-center gap-1">
                            <span class="text-[9px] font-bold text-slate-500">${name}</span>
                            <div class="flex flex-col gap-1">
                                <div class="slot ${picks[0]?'active':''}" onclick="toggleSlot(${d}, '${name}', 0)"></div>
                                <div class="slot ${picks[1]?'active':''}" onclick="toggleSlot(${d}, '${name}', 1)"></div>
                                <div class="slot ${picks[2]?'active':''}" onclick="toggleSlot(${d}, '${name}', 2)"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                const shifts = dayData.finalShifts || {};
                const isSat = dow === "週六";

                row.innerHTML = `
                    <div class="flex justify-between items-center mb-2 border-b border-slate-700/50 pb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-lg font-black ${dow==='六'?'text-rose-400':'text-white'}">${d}</span>
                            <span class="text-[10px] font-bold text-slate-500">${dow}</span>
                        </div>
                        <div class="flex gap-1">
                            <div class="shift-tag ${shifts['M']?'filled':''}">早:${shifts['M']||'--'}</div>
                            <div class="shift-tag ${shifts['A']?'filled':''}">午:${shifts['A']||'--'}</div>
                            <div class="shift-tag ${shifts['E']?'filled':''}">晚:${shifts['E']||'--'}</div>
                        </div>
                    </div>
                    <div class="flex justify-between px-2">
                        ${staffHtml}
                    </div>
                `;
                container.appendChild(row);
            }
            updateTStats();
        }

        function toggleSlot(day, name, slotIdx) {
            if(!db[day]) db[day] = { userPicks: {}, finalShifts: {} };
            if(!db[day].userPicks[name]) db[day].userPicks[name] = [false, false, false];
            
            db[day].userPicks[name][slotIdx] = !db[day].userPicks[name][slotIdx];
            localStorage.setItem('monthly_schedule_v2.3', JSON.stringify(db));
            render();
        }

        function autoFillAll() {
            for(let d=1; d<=28; d++) {
                const dow = getDow(d);
                if(!db[d]) db[d] = { userPicks: {}, finalShifts: {} };
                
                let picks = db[d].userPicks;
                let dayCount = {};
                staffList.forEach(n => dayCount[n] = 0);

                // 統計玩家手動點亮的班
                let results = { M: null, A: null, E: null };
                staffList.forEach(n => {
                    const p = picks[n] || [false, false, false];
                    if(p[0]) { results.M = n; dayCount[n]++; }
                    if(p[1]) { results.A = n; dayCount[n]++; }
                    if(p[2]) { results.E = n; dayCount[n]++; }
                });

                // 填補剩下沒人的班 (簡易優先級：選今天班最少的人)
                ["M", "A", "E"].forEach((shift, idx) => {
                    if(!results[shift]) {
                        let available = staffList.filter(n => {
                            const p = picks[n] || [false, false, false];
                            // 排除「全休」(三格都沒點的人視為全休)
                            const isOff = p.every(v => v === false);
                            return !isOff && dayCount[n] < 2;
                        });
                        available.sort((a, b) => dayCount[a] - dayCount[b]);
                        if(available.length > 0) {
                            results[shift] = available[0];
                            dayCount[available[0]]++;
                        }
                    }
                });
                db[d].finalShifts = results;
            }
            localStorage.setItem('monthly_schedule_v2.3', JSON.stringify(db));
            render();
        }

        function updateTStats() {
            const counts = {}; staffList.forEach(n => counts[n] = 0);
            Object.values(db).forEach(day => {
                if(day.finalShifts) {
                    Object.values(day.finalShifts).forEach(n => { if(n && counts[n]!==undefined) counts[n]++; });
                }
            });
            document.getElementById('t_stats').innerHTML = staffList.map(n => `<span>${n}: ${counts[n]}班</span>`).join('');
        }

        window.onload = render;
    </script>
</body>
</html>
