<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>智能排班 V2.6 - 邏輯修復版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0b1120; color: #f1f5f9; font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .card { background-color: #1e293b; border-radius: 12px; padding: 0.8rem; border: 1px solid #334155; }
        .slot { width: 20px; height: 20px; border-radius: 4px; border: 1px solid #475569; cursor: pointer; position: relative; }
        .slot.active { background-color: #f59e0b; border-color: #fbbf24; }
        .slot.active::after { content: '休'; font-size: 10px; color: #0f172a; position: absolute; left: 2px; top: 0px; font-weight: 900; }
        .shift-tag { font-size: 11px; font-weight: 800; padding: 3px 6px; border-radius: 6px; background: #0f172a; color: #64748b; border: 1px solid #334155; display: block; width: 100%; }
        .shift-tag.filled { color: #38bdf8; border-color: #38bdf8; background: rgba(56, 189, 248, 0.1); }
        .sun-row { opacity: 0.4; background-color: #020617; pointer-events: none; }
        .btn-magic { background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%); transition: 0.2s; }
        .btn-magic:hover { filter: brightness(1.1); }
    </style>
</head>
<body class="p-4 pb-24">
    <div class="max-w-md mx-auto space-y-4">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-black text-white italic tracking-tighter">V2.6 SCHEDULER</h1>
                <p class="text-[10px] text-amber-400 font-bold uppercase tracking-widest">橘色(點亮) = 請假 | 灰色 = 上班</p>
            </div>
            <button onclick="autoFillAll()" class="btn-magic text-white text-[12px] font-black px-6 py-3 rounded-xl shadow-xl active:scale-95">
                ✨ 開始自動排班
            </button>
        </div>
        <div id="list_container" class="space-y-4"></div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-md p-4 border-t border-slate-700 z-50">
        <div id="t_stats" class="max-w-md mx-auto flex justify-around text-[10px] font-black text-indigo-400"></div>
    </div>

    <script>
        const staffList = ["A", "B", "C", "D", "E"];
        let db = JSON.parse(localStorage.getItem('monthly_schedule_v2.6')) || {};

        function getDow(d) {
            return new Date(2026, 1, d).getDay();
        }

        function render() {
            const container = document.getElementById('list_container');
            container.innerHTML = '';
            const dowNames = ["週日", "週一", "週二", "週三", "週四", "週五", "週六"];

            for (let d = 1; d <= 28; d++) {
                const dow = getDow(d);
                const isSun = (dow === 0);
                const isSat = (dow === 6);
                const dayData = db[d] || { userOff: {}, finalShifts: {} };
                
                const row = document.createElement('div');
                row.className = `card ${isSun ? 'sun-row' : ''}`;
                
                let staffGrid = staffList.map(name => {
                    const off = dayData.userOff[name] || [false, false, false];
                    return `
                        <div class="flex flex-col items-center gap-1.5">
                            <span class="text-[10px] font-bold text-slate-400">${name}</span>
                            <div class="flex flex-col gap-1.5">
                                <div class="slot ${off[0]?'active':''}" onclick="toggleOff(${d}, '${name}', 0)"></div>
                                <div class="slot ${off[1]?'active':''}" onclick="toggleOff(${d}, '${name}', 1)"></div>
                                <div class="slot ${off[2]?'active':''}" onclick="toggleOff(${d}, '${name}', 2)"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                const fs = dayData.finalShifts || {};

                row.innerHTML = `
                    <div class="flex justify-between">
                        <div class="w-1/3 pr-2 border-r border-slate-700/50">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl font-black ${isSat?'text-rose-400':'text-white'}">${d}</span>
                                <span class="text-[10px] font-bold text-slate-500">${dowNames[dow]}</span>
                            </div>
                            <div class="space-y-1.5">
                                <div class="shift-tag ${fs.M?'filled':''}">早: ${fs.M || '--'}</div>
                                <div class="shift-tag ${fs.A?'filled':''}">午: ${fs.A || '--'}</div>
                                <div class="shift-tag ${fs.E?'filled':''}">晚: ${fs.E || '--'}</div>
                                ${isSat ? `<div class="shift-tag filled border-rose-500/50">補: ${fs.S || '--'}</div>` : ''}
                            </div>
                        </div>
                        <div class="flex-1 flex justify-around items-center pl-2">
                            ${isSun ? '<span class="text-xs font-black text-slate-700 italic">STORE CLOSED</span>' : staffGrid}
                        </div>
                    </div>
                `;
                container.appendChild(row);
            }
            updateTStats();
        }

        function toggleOff(day, name, slotIdx) {
            if(!db[day]) db[day] = { userOff: {}, finalShifts: {} };
            if(!db[day].userOff[name]) db[day].userOff[name] = [false, false, false];
            db[day].userOff[name][slotIdx] = !db[day].userOff[name][slotIdx];
            localStorage.setItem('monthly_schedule_v2.6', JSON.stringify(db));
            render();
        }

        function autoFillAll() {
            for(let d = 1; d <= 28; d++) {
                if(getDow(d) === 0) continue; // 跳過週日

                if(!db[d]) db[d] = { userOff: {}, finalShifts: {} };
                const userOff = db[d].userOff;
                let dayCount = {};
                staffList.forEach(n => dayCount[n] = 0);

                let results = { M: null, A: null, E: null, S: null };
                const dow = getDow(d);
                const shiftTasks = (dow === 6) ? ["M", "A", "E", "S"] : ["M", "A", "E"];
                const shiftIdxMap = { "M": 0, "A": 1, "E": 2, "S": 1 }; // S 補位通常在下午

                shiftTasks.forEach(task => {
                    const idx = shiftIdxMap[task];
                    // 核心邏輯：找出這時段「沒點亮(沒休假)」且「今天還沒上滿兩班」且「這班還沒被其他人佔走」的人
                    let pool = staffList.filter(name => {
                        const offArr = userOff[name] || [false, false, false];
                        return offArr[idx] === false && 
                               dayCount[name] < 2 && 
                               !Object.values(results).includes(name);
                    });

                    // 排序：今天上最少班的人優先
                    pool.sort((a, b) => dayCount[a] - dayCount[b]);

                    if(pool.length > 0) {
                        results[task] = pool[0];
                        dayCount[pool[0]]++;
                    }
                });
                db[d].finalShifts = results;
            }
            localStorage.setItem('monthly_schedule_v2.6', JSON.stringify(db));
            render();
            alert("✅ 全月排班填補完成！");
        }

        function updateTStats() {
            const counts = {}; staffList.forEach(n => counts[n] = 0);
            Object.values(db).forEach(day => {
                if(day.finalShifts) {
                    Object.values(day.finalShifts).forEach(n => { if(n && counts[n]!==undefined) counts[n]++; });
                }
            });
            document.getElementById('t_stats').innerHTML = staffList.map(n => `<span>${n}: ${counts[n]} 班</span>`).join('');
        }

        window.onload = render;
    </script>
</body>
</html>
