<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>智能排班 V2.8 - 營運優化版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0b1120; color: #f1f5f9; font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .card { background-color: #1e293b; border-radius: 12px; padding: 0.8rem; border: 1px solid #334155; }
        .slot { width: 22px; height: 22px; border-radius: 4px; border: 1px solid #475569; cursor: pointer; position: relative; }
        .slot.active { background-color: #f59e0b; border-color: #fbbf24; }
        .slot.active::after { content: '休'; font-size: 11px; color: #0f172a; position: absolute; left: 3px; top: 0px; font-weight: 900; }
        .shift-tag { font-size: 11px; font-weight: 800; padding: 4px 6px; border-radius: 6px; background: #0f172a; color: #38bdf8; border: 1px solid #38bdf8/30; display: block; width: 100%; margin-bottom: 3px; }
        .sun-row { opacity: 0.4; background-color: #020617; pointer-events: none; }
        .btn-magic { background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%); }
    </style>
</head>
<body class="p-4 pb-32">
    <div class="max-w-md mx-auto space-y-4">
        
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-black italic tracking-tighter">OP-SCHEDULER V2.8</h1>
            <button onclick="autoFillAll()" class="btn-magic text-white text-[12px] font-black px-6 py-3 rounded-xl shadow-xl active:scale-95">
                ✨ 依照營運規則排班
            </button>
        </div>

        <div class="card border-dashed">
            <p class="text-[10px] text-slate-500 font-bold mb-2 uppercase">員工名單 (請用逗號隔開)</p>
            <input type="text" id="staff_input" onchange="updateStaffNames()" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-2 text-xs text-sky-400 font-bold" value="員工A,員工B,員工C,員工D,員工E">
        </div>

        <div id="list_container" class="space-y-4"></div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-md p-4 border-t border-slate-700 z-50">
        <div id="t_stats" class="max-w-md mx-auto flex justify-around text-[9px] font-black text-indigo-400 flex-wrap gap-2"></div>
    </div>

    <script>
        let staffList = ["員工A", "員工B", "員工C", "員工D", "員工E"];
        let db = JSON.parse(localStorage.getItem('monthly_db_v2.8')) || {};

        function updateStaffNames() {
            const val = document.getElementById('staff_input').value;
            staffList = val.split(',').map(s => s.trim()).filter(s => s !== "");
            localStorage.setItem('staff_list_v2.8', JSON.stringify(staffList));
            render();
        }

        function getDow(d) { return new Date(2026, 1, d).getDay(); }

        function render() {
            const container = document.getElementById('list_container');
            container.innerHTML = '';
            const dowNames = ["週日", "週一", "週二", "週三", "週四", "週五", "週六"];

            for (let d = 1; d <= 28; d++) {
                const dow = getDow(d);
                const isSun = (dow === 0);
                const dayData = db[d] || { userOff: {}, finalShifts: {} };
                
                let staffGrid = staffList.map(name => {
                    const off = (dayData.userOff && dayData.userOff[name]) ? dayData.userOff[name] : [false, false, false];
                    return `
                        <div class="flex flex-col items-center gap-1.5">
                            <span class="text-[9px] font-bold text-slate-500">${name.substring(0,2)}</span>
                            <div class="flex flex-col gap-1.5">
                                <div class="slot ${off[0]?'active':''}" onclick="toggleOff(${d}, '${name}', 0)"></div>
                                <div class="slot ${off[1]?'active':''}" onclick="toggleOff(${d}, '${name}', 1)"></div>
                                <div class="slot ${off[2]?'active':''}" onclick="toggleOff(${d}, '${name}', 2)"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                const fs = dayData.finalShifts || { M:[], A:[], E:[] };

                let rowHtml = `
                    <div class="card ${isSun ? 'sun-row' : ''}">
                        <div class="flex">
                            <div class="w-2/5 pr-2 border-r border-slate-700/50">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-2xl font-black ${dow===6?'text-rose-400':'text-white'}">${d}</span>
                                    <span class="text-[10px] font-bold text-slate-500">${dowNames[dow]}</span>
                                </div>
                                <div class="space-y-1">
                                    <div class="shift-tag">早: ${(fs.M||[]).join(',')}</div>
                                    <div class="shift-tag">午: ${(fs.A||[]).join(',')}</div>
                                    <div class="shift-tag">晚: ${(fs.E||[]).join(',')}</div>
                                </div>
                            </div>
                            <div class="flex-1 flex justify-around items-center pl-2">
                                ${isSun ? '<span class="text-xs font-black text-slate-700 italic">CLOSED</span>' : staffGrid}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += rowHtml;
            }
            updateTStats();
        }

        function toggleOff(day, name, slotIdx) {
            if(!db[day]) db[day] = { userOff: {}, finalShifts: { M:[], A:[], E:[] } };
            if(!db[day].userOff[name]) db[day].userOff[name] = [false, false, false];
            db[day].userOff[name][slotIdx] = !db[day].userOff[name][slotIdx];
            localStorage.setItem('monthly_db_v2.8', JSON.stringify(db));
            render();
        }

        function autoFillAll() {
            for(let d = 1; d <= 28; d++) {
                const dow = getDow(d);
                if(dow === 0) continue;
                
                if(!db[d]) db[d] = { userOff: {}, finalShifts: {} };
                const userOff = db[d].userOff || {};
                let dayCount = {};
                staffList.forEach(n => dayCount[n] = 0);
                let dayResults = { M: [], A: [], E: [] };

                // 定義每天各時段的人數上限
                let limits = { M: 3, A: 3, E: 3 }; 
                if (dow >= 1 && dow <= 4) limits = { M: 3, A: 3, E: 3 };
                if (dow === 5) limits = { M: 2, A: 2, E: 3 };
                if (dow === 6) limits = { M: 4, A: 4, E: 2 };

                ["M", "A", "E"].forEach((shiftKey, idx) => {
                    let available = staffList.filter(name => {
                        const offArr = userOff[name] || [false, false, false];
                        return offArr[idx] === false && dayCount[name] < 2;
                    });

                    // 排序：優先讓今天班少的人上
                    available.sort((a, b) => dayCount[a] - dayCount[b]);

                    while(dayResults[shiftKey].length < limits[shiftKey] && available.length > 0) {
                        let person = available.shift();
                        // 禮拜六早午班第四人顯示為 (S)
                        let displayName = (dow === 6 && (shiftKey === "M" || shiftKey === "A") && dayResults[shiftKey].length === 3) ? person + "(S)" : person;
                        dayResults[shiftKey].push(displayName);
                        dayCount[person]++;
                    }
                });
                db[d].finalShifts = dayResults;
            }
            localStorage.setItem('monthly_db_v2.8', JSON.stringify(db));
            render();
            alert("✅ 營運策略排班完成！");
        }

        function updateTStats() {
            const counts = {}; staffList.forEach(n => counts[n] = 0);
            Object.values(db).forEach(day => {
                if(day.finalShifts) {
                    ["M","A","E"].forEach(k => {
                        (day.finalShifts[k]||[]).forEach(nameWithS => {
                            let pureName = nameWithS.replace("(S)", "");
                            if(counts[pureName] !== undefined) counts[pureName]++;
                        });
                    });
                }
            });
            document.getElementById('t_stats').innerHTML = staffList.map(n => `<span>${n}:${counts[n]}班</span>`).join('');
        }

        window.onload = () => {
            const savedList = localStorage.getItem('staff_list_v2.8');
            if(savedList) {
                staffList = JSON.parse(savedList);
                document.getElementById('staff_input').value = staffList.join(',');
            }
            render();
        };
    </script>
</body>
</html>
